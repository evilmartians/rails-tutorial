#!/usr/bin/env -S node --disable-warning=ExperimentalWarning

import initVM from "../lib/rails.js";
import repl from "node:repl";

const vm = await initVM();

const isRecoverableError = (error) => {
  if (error.message.includes('SyntaxError')) {
    return /^(unexpected)/i.test(error.message);
  }

  return false;
}

const rubyEval = async (cmd, context, filename, callback) => {
  let result;
  try {
    result = await vm.evalAsync(cmd);
  } catch (e) {
    if (e.message.includes('SystemExit')) {
      process.exit();
    }
    if (isRecoverableError(e)) {
      return callback(new repl.Recoverable(e));
    }

    return callback(null, e.message);
  }
  callback(null, result);
}

const rubyWriter = async (output) => {
  if (!output) return;

  if (typeof output === 'string') {
    return output;
  }

  const res = await output.callAsync('inspect');
  return res.toString();
}

vm.eval(`
  require_relative "config/environment"

  ActiveRecord::Base.logger = Logger.new(STDOUT)

  connection = ActiveRecord::Base.connection
`)

const local = repl.start({prompt: '> ', eval: rubyEval, writer: rubyWriter});

local.on('exit', () => {
  // TODO: save history?
  process.exit();
});
