#!/usr/bin/env -S node --disable-warning=ExperimentalWarning

import initVM from "../lib/rails.js";
import util from "node:util";
import fs from "node:fs";

const args = process.argv.slice(2);

if (args[0] && fs.existsSync(process.cwd() + '/' + args[0])) {
  const firstLine = fs.readFileSync(process.cwd() + '/' + args[0], 'utf8').split('\n')[0];
  // Check if called via shebang
  if (firstLine.includes('#!/usr/bin/env ruby')) {
    const path = args.shift();
    const vm = await initVM({ env: { "HOME": "/rails-vm" } });

    await vm.evalAsync(`
      args = ${util.inspect(args)}
      ARGV.replace(args)

      begin
        load "./${path}"
      rescue SystemExit
      end
    `);
  }
} else {
  await initVM({ env: { "HOME": "/rails-vm" }, args, skipRails: true });
}
